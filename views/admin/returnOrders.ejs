<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReturnOrders</title>
    <link rel="stylesheet" href="/assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="/assets/vendors/jvectormap/jquery-jvectormap.css">
    <link rel="stylesheet" href="/assets/vendors/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" href="/assets/vendors/owl-carousel-2/owl.carousel.min.css">
    <link rel="stylesheet" href="/assets/vendors/owl-carousel-2/owl.theme.default.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="shortcut icon" href="/assets/images/favicon.png" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
</head>
<body>
    <div class="container-scroller">
        <!-- Sidebar -->
        <%- include('partials/sidebar') %>
        <!-- Navbar -->
        <%- include('partials/navbar') %>
            <div class="container-fluid page-body-wrapper">
                <div class="main-panel">
                    <div class="content-wrapper">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">ReturnOrders</h4>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sl.No</th>
                                                <th>Order ID</th>
                                                <th>User Name</th>
                                                <th>User Email</th>
                                                <th>Product</th>
                                                <th>Reason</th>
                                                <th>Returned At:</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="order-table-body">
                                            <% returnOrders.forEach((order,index) => { %>
                                                
                                                    <tr>
                                                        <td><%= index + 1 + (currentPage - 1) * 5 %></td>
                                                        <td><%= order.OrderId %></td>
                                                        <td><%= order.userId.name %></td>
                                                        <td><%= order.userId.email %></td>
                                                        <td>
                                                          <ul>
                                                             <% order.items.forEach(item => { %>
                                                                <li><%= item.titleAtOrder %> (Qty: <%= item.quantity %>)</li>
                                                              <% }) %>
                                                          </ul>
                                                        </td>
                                                        <td><%=order.returnReason %></td> 
                                                        <td><%=order.returnedAt.toLocaleString() %></td>   
                                                        <td>
                                                           
                                                            <% if (order.returnStatus === 'requested') { %>
                                                                <!-- Approve and Reject buttons for each return request -->
                                                                <button class="btn btn-primary" type="button" onclick="confirmReturn('<%= order._id %>')">Accept</button>
                                                                <button class="btn btn-danger" type="button" onclick="rejectReturn('<%= order._id %>')">Reject</button>
                                                                    
                                                            <% } %>
                                                        </td> 
                                                    </tr>
                                                <% }) %>
                                                <% if(returnOrders.length==0){ %>
                                                   <tr>
                                                    <td>No return oreders..</td>
                                                   </tr>
                                                <% } %>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Pagination Controls -->
                                <div class="pagination">
                                    <% if (currentPage > 1) { %>
                                        <a href="?page=<%= currentPage - 1 %>">Previous</a>
                                    <% } %>
            
                                    <% for (let i = 1; i <= totalPages; i++) { %>
                                        <a href="?page=<%= i %>" class="<%= i === currentPage ? 'active' : '' %>"><%= i %></a>
                                    <% } %>
            
                                    <% if (currentPage < totalPages) { %>
                                        <a href="?page=<%= currentPage + 1 %>">Next</a>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>                                  
                    <!-- Footer -->
                    <%- include('partials/footer') %>   
                </div>  
            </div>
            <style>
            .pagination {
                display: flex;
                justify-content: center;
                margin-top: 20px;
            }
        
            .pagination a {
                margin: 0 5px;
                padding: 8px 12px;
                background-color: #f0f0f0;
                color: #333;
                text-decoration: none;
            }
        
            .pagination a.active {
                background-color: #007bff;
                color: white;
            }
        
            .pagination a:hover {
                background-color: #ddd;
            }
        </style>    
    </div>   
    <script src="/assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="/assets/js/dashboard.js"></script>
    <script>
        function confirmReturn(orderId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You want to accept this return request?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, accept!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/acceptReturn/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                Swal.fire('Accepted!', data.message, 'success').then(() => location.reload());
              } else {
                Swal.fire('Error!', data.message, 'error');
              }
            })
            .catch((error) => {
              Swal.fire('Error!', 'Something went wrong!', 'error');
              console.error('Error:', error);
            });
        }
      });
    }
  
    function rejectReturn(orderId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You want to reject this return request?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, reject!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/rejectReturn/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                Swal.fire('Rejected!', data.message, 'success').then(() => location.reload());
              } else {
                Swal.fire('Error!', data.message, 'error');
              }
            })
            .catch((error) => {
              Swal.fire('Error!', 'Something went wrong!', 'error');
              console.error('Error:', error);
            });
        }
      });
    }
  </script>          

    
    
</body>
</html>